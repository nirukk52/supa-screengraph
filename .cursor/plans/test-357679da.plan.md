<!-- 357679da-3c36-45e6-a132-724c6d1c13ff 9041781a-b43b-4f12-9295-5f8cbff74714 -->
# Feature: BullMQ + pg-listen Deterministic Infra for agents-run

## Goals

- Resolve all open test infra bugs (BUG-TEST-001..007) by eliminating interval races and shared-singleton leakage.
- Standardize job queue on BullMQ (Redis) with Testcontainers for tests.
- Keep Postgres outbox, replace polling interval with pg-listen (LISTEN/NOTIFY) and step APIs.
- Make tests fully observable-driven (no sleeps), prod-ready (no temporary in-memory infra) by end of M5.

## Decisions

- Queue/jobs: BullMQ (Redis). Tests use Testcontainers Redis.
- Outbox: Postgres table + pg-listen (no polling). Provide drainOnce/step API for tests.
- Test control: p-event + Vitest (or @sinonjs/fake-timers when needed), RxJS TestScheduler for any local streams.
- Lifecycle: workers expose start/stop; tests never rely on global intervals.

## Scope

- packages/queue-bullmq/: new BullMQ adapter implementing `QueuePort`.
- packages/features/agents-run:
- src/application/infra.ts: bind queue to BullMQ in prod; test harness sets Testcontainers Redis client.
- src/infra/workers/run-worker.ts: unchanged semantics, relies on queue port.
- src/infra/workers/outbox-publisher.ts: remove setInterval; add pg-listen subscriber + `startOutbox`, `stopOutbox`, `drainOutboxOnce`.
- tests/integration/helpers/: harness provisions Redis container; awaits worker readiness; uses step/drain (no timers).
- packages/database/: add lightweight NOTIFY triggers or explicit NOTIFY on run_event insert; small migration if needed.
- tooling/testcontainers: add vitest-testcontainers config for Redis.

## Implementation Phases

### Phase A: BullMQ adapter

- Create `packages/queue-bullmq` with `Queue` and `Worker` wrappers (pause/resume/drain/obliterate helpers for tests).
- Wire into `agents-run` infra via config flag/env (prod=BullMQ, tests=Testcontainers Redis instance).

### Phase B: pg-listen outbox

- Add pg-listen subscriber in `outbox-publisher` (`startOutbox({ onEvent })`).
- Emit when new `run_event` rows arrive; publish sequentially; expose `drainOutboxOnce(runId)` for deterministic tests.
- Remove polling `setInterval`; keep a thin scheduler wrapper if needed for prod.

### Phase C: Test harness + helpers

- Introduce Redis Testcontainers lifecycle, isolate per-worker or per-file.
- Replace `setTimeout` waits with:
- `waitForRunCompletion(runId)` (unchanged)
- `p-event` on bus/queue to await RunFinished
- Queue control: `pause/resume/drain` where appropriate
- Unskip `outbox.spec.ts` using `drainOutboxOnce` (no interval active).

### Phase D: Docs + lint + scaffold

- Update `docs/jira/feature-requests/` with this feature.
- Update M5 milestone: add new feature; mark DEBT-0002 unblocked; close BUG-TEST-004/007 after verification.
- Scaffold: generate BullMQ adapter boilerplate, test harness (Redis), and pg-listen pattern; add lint rule preventing in-memory queue in prod code.

## Affected Files (key)

- `packages/queue-bullmq/src/index.ts`
- `packages/features/agents-run/src/application/infra.ts`
- `packages/features/agents-run/src/infra/workers/run-worker.ts`
- `packages/features/agents-run/src/infra/workers/outbox-publisher.ts`
- `packages/features/agents-run/tests/integration/helpers/test-harness.ts`
- `packages/database/prisma/migrations/*` (if NOTIFY/trigger used) and `prisma/schema.prisma`
- `tooling/scripts/scaffold/index.ts`
- `vitest.config.ts` (enable parallel once stable)

## Testing Strategy

- Unit: adapter behaviors (BullMQ pause/resume/drain), pg-listen subscriber.
- Integration: agents-run golden path, backfill, outbox publish order, stream completeness—3× runs, no sleeps.
- E2E: basic API run flow; ensure no worker boot in e2e unless desired.

## Acceptance Criteria

- All 6 testing bugs closed or updated to Resolved.
- Integration tests green 3× locally and in CI, with parallel workers enabled.
- No `setTimeout`-based synchronization in tests.
- No in-memory queue in prod paths; prod uses BullMQ; outbox uses pg-listen.

## Risks & Mitigations

- Redis infra in CI: use Testcontainers Redis; document resource limits.
- LISTEN/NOTIFY volume: ensure NOTIFY granularity (per-run or batched) and backpressure via drainOnce.
- Migration timing: feature-flag worker swap; can fall back to polling temporarily if needed.

### To-dos

- [ ] Pick FEAT number for FEAT-{featureNumber}-5 tracking doc
- [ ] Add Awilix and RxJS to workspace and lockfile
- [ ] Implement createContainer in container.ts with bus, queue, workers
- [ ] Expose orchestrateOnce and publishPendingOutboxEventsOnce
- [ ] Add prod adapter to keep public API unchanged
- [ ] Update test harness to build per-test container and use fakes
- [ ] Refactor agents-run integration tests to container harness
- [ ] Enforce boundaries and no-restricted-imports for tests
- [ ] Document optional pg-listen follow-up in tech-debt
- [ ] Create docs/features/FEAT-XX-5.md with design and rollout
- [ ] Update milestone-5(current) status, handoff, retro with feature tag
- [ ] Add bugs to docs/bug-logs and tech debt to docs/tech-debt
- [ ] Update CLAUDE docs per trailer requirement
- [ ] Run integration tests 3x locally to verify determinism
- [ ] Open PR, ensure CI green, merge