<!-- 357679da-3c36-45e6-a132-724c6d1c13ff 00193137-3782-4c28-b812-803293e34109 -->
# M5.5 Phase 1 – Per‑test DI, Small PRs, Zero Ballooning

## Constraints & Guardrails

- PRs ≤ 500 changed LOC, ≤ 5 files modified
- Keep prod behavior stable (lazy singleton wrapper for prod only)
- After each PR: run `pnpm pr:check` locally, open PR, require CI green before merge
- By Phase end: 33/33 tests passing, 0 skipped, still single‑threaded (parallelization is Phase 2)

## Definition of Done per PR

- Code diff ≤ 500 LOC; unit + integration tests pass locally
- `pnpm pr:check` green
- PR description lists scope, files touched, test evidence (copy/paste vitest summary)
- No unrelated refactors or format-only changes

## PR Sequence (Sequential, Focused)

### PR‑01: Container Factory (additive only) ✅

- Files: `packages/features/agents-run/src/application/container.ts` (update), `packages/features/agents-run/src/application/container.types.ts` (new)
- Add `createAgentsRunContainer({ overrides })` registering bus, queue, and outbox worker dependencies
- Register deterministic helpers: `drainOutboxForRun`, `enqueueDrain`
- No runtime usage; pure addition
- Tests: None (existing suite unchanged)
- **Status**: COMPLETE - PR #75 opened

### PR‑02: Harness adopts DI (per‑test container)

- File: `…/tests/integration/helpers/test-harness.ts`
- `runAgentsRunTest` builds container before test, passes `{ container }` to callback, awaits `dispose()` in finally
- No unskips yet; suite must remain green

### PR‑03: `infra.ts` accepts optional container (no removal yet)

- File: `…/src/application/infra.ts`
- `getInfra(container?: AgentsRunContainer)`; when omitted, fallback to existing singleton for prod paths
- No behavior change; tests remain green

### PR‑04: Unskip stream.spec (canonical sequence)

- File: `…/tests/integration/stream.spec.ts`
- Use `{ container }` and DI‑aware `getInfra(container)` if needed; replace sleeps with existing deterministic helpers
- Unskip 1 test; suite green

### PR‑05: Unskip outbox.spec (ordering + publishedAt)

- File: `…/tests/integration/outbox.spec.ts`
- Ensure worker not auto‑started in test; use deterministic drain helper; DI usage as above
- Unskip 1 test; suite green

### PR‑06: Unskip orchestrator – Golden Path

- File: `…/tests/integration/orchestrator-integration.spec.ts` (first test only)
- Unskip "golden path" test; keep concurrent test skipped
- Suite green

### PR‑07: Unskip orchestrator – Concurrent Isolation

- Same file; unskip second test, ensure isolation via DI containers
- Suite green

### PR‑08: Unskip stream‑backfill (resume + de‑dupe)

- File: `…/tests/integration/stream-backfill.spec.ts`
- DI usage; validate backfill window and dedupe semantics
- Suite green

### PR‑09: Remove test‑time singleton; keep prod lazy wrapper

- File: `…/src/application/infra.ts` (+ any callers)
- Remove mutable module‑level singleton from test paths; add prod‑only lazy factory to preserve runtime API
- Verify full suite green (33/33), still single‑thread

### PR‑10: Docs, hygiene (tiny)

- Files: `packages/CLAUDE.md`, `…/tests/CLAUDE.md`
- Document DI patterns, cleanup invariants, test harness contract
- No code behavior change

## CI Ritual per PR (must pass before merge)

1. `pnpm install`
2. `pnpm pr:check` (format, lint, build, unit + integration)
3. Attach vitest summary to PR
4. Merge when checks green

## Success Criteria (Phase 1)

- Per‑test containers created and disposed deterministically
- 33/33 tests passing; 0 skipped; single‑threaded
- No regressions; diffs small; prod behavior stable

### To-dos

- [ ] Implement createAgentsRunContainer and types (additive only)
- [ ] Open PR-01; attach local pr:check summary; request review
- [ ] Merge PR-01 after all CI checks green
- [ ] Refactor test-harness to build/cleanup per-test container
- [ ] Open PR-02; attach pr:check; ensure no unskips yet
- [ ] Merge PR-02 after CI green
- [ ] Make getInfra accept optional container; keep fallback
- [ ] Open PR-03; attach pr:check; no behavior change
- [ ] Merge PR-03 after CI green
- [ ] Unskip stream.spec using DI container
- [ ] Open PR-04; attach pr:check; suite green
- [ ] Merge PR-04 after CI green
- [ ] Unskip outbox.spec; ensure deterministic drain
- [ ] Open PR-05; attach pr:check; suite green
- [ ] Merge PR-05 after CI green
- [ ] Unskip orchestrator golden path test
- [ ] Open PR-06; attach pr:check; suite green
- [ ] Merge PR-06 after CI green
- [ ] Unskip orchestrator concurrent isolation test
- [ ] Open PR-07; attach pr:check; suite green
- [ ] Merge PR-07 after CI green
- [ ] Unskip stream-backfill.spec (resume + de-dupe)
- [ ] Open PR-08; attach pr:check; suite green
- [ ] Merge PR-08 after CI green
- [ ] Remove test-time singleton; add prod lazy wrapper
- [ ] Open PR-09; attach pr:check; 33/33 tests passing
- [ ] Merge PR-09 after CI green
- [ ] Docs updates for DI patterns and invariants
- [ ] Open PR-10; attach pr:check; no code behavior change
- [ ] Merge PR-10 after CI green