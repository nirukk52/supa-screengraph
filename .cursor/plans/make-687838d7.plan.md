<!-- 687838d7-d168-478e-930e-f688d4548430 5bfecbcf-d50c-493b-8073-34c680036f98 -->
# M5.5 – All agents-run integration tests pass without skips

## Objective

Make the agents-run integration suite fully green (33/33, 0 skipped) by:

- Isolating worker lifecycle per test (no shared state)
- Providing a deterministic, step/once outbox API
- Using per-test DI containers end-to-end (startRun, worker, stream)

## Constraints

- Diff ≤ 500 LOC per PR-equivalent change; ≤ 5 files touched
- No behavior regressions in prod; test-only behavior via DI overrides/adapters
- Keep tests single-threaded for now; parallelization tracked under DEBT-0002

## Current RCA (from milestone + debt docs)

- Shared in-memory bus/queue across tests causes flake (DEBT-0002)
- Background worker with timers mutates shared module state; no step API (DEBT-0003)
- Worker and `startRun` sometimes use different queue instances
- Streaming tests depend on implicit timing; need explicit drain/step pumps

## Implementation Plan

### 1) Per-test infra isolation (DEBT-0002 – core pieces now)

- Ensure `runAgentsRunTest` builds a fresh `container` with new `InMemoryEventBus` and `InMemoryQueue` for each test.
- Ensure `startRun`, `streamRun`, workers, and outbox publisher accept and consistently use the provided `container` (no fallback to global within tests).
- Guarantee worker lifecycle per test: `startWorker(container)` returns a controller `{ start, stop }` and is invoked from the harness.

### 2) Deterministic Outbox Controller (DEBT-0003 – resolve)

- Expose a test-facing controller: `{ start, stop, stepOnce(runId?), stepAll(runId?) }` wrapping `publishPendingOutboxEventsOnce`.
- In tests, disable any intervals; use `stepOnce/stepAll` after enqueues to flush outbox deterministically.
- In prod, provide an interval scheduler adapter that calls `stepAll` on cadence.

### 3) Orchestrator Golden Path (PR-06)

- Start worker with the same per-test container used by `startRun`.
- After `startRun`, call `queueWorker.stepAll()` and `outboxController.stepAll(runId)` to flush; assert DB monotonic seq and completion.
- Validation via DB (deterministic) and minimal live-stream check with bounded time.

### 4) Orchestrator Concurrent (PR-07)

- Trigger two runs in the same test with the same container/worker.
- Use alternating `stepAll()` pumps to simulate concurrency; assert per-run monotonic seq and isolation.

### 5) Stream Backfill (PR-08)

- Use `streamRun(runId, fromSeq, container)` while a background async task calls `outboxController.stepAll(runId)` until finish.
- Assert: backfill yields from `fromSeq+1..N`, then live emits strictly > last seq; no duplicates.

### 6) Stream Canonical (stream.spec)

- Similar pump pattern without `fromSeq`; assert canonical monotonic seq and termination after RunFinished.

### 7) Remove test-time singleton (PR-09)

- Eliminate test paths that call global `getInfra()`; keep prod fallback for runtime API.
- Ensure all tests wire through the per-test container.

### 8) Documentation and Tech Debt

- Mark DEBT-0003 Resolved when controller lands; DEBT-0002 to In Progress with acceptance tied to enabling parallel later.
- Update milestone 5.5 with new results and acceptance evidence.

### 9) Verification

- Run `pnpm vitest run packages/features/agents-run/tests/integration` 3x locally
- Run `pnpm pr:check` and ensure green

## Acceptance Criteria

- 33/33 tests passing; 0 skipped
- No global/shared worker state across tests
- Deterministic step/once API used in tests (no timers)
- PR checks green; milestone docs updated with evidence

### To-dos

- [ ] Ensure per-test container with fresh bus/queue; forbid global fallbacks
- [ ] Make startWorker(container) return {start, stop}; use only in tests via harness
- [ ] Add OutboxController with start/stop/stepOnce/stepAll; no timers in tests
- [ ] Make orchestrator golden path pass using worker+outbox step pumps
- [ ] Make orchestrator concurrent test pass with per-run monotonic seq
- [ ] Make stream backfill pass via stream pump and de-dupe checks
- [ ] Make canonical stream test pass with termination sentinel
- [ ] Remove test-time singleton usage; rely only on container in tests
- [ ] Update milestone and mark DEBT-0003 resolved; DEBT-0002 in progress
- [ ] Run suite 3x and pr:check; attach evidence in milestone