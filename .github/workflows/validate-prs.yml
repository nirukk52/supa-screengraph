name: pr-check

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  DATABASE_URL: "postgresql://test:test@localhost:5432/test"
  BETTER_AUTH_SECRET: "test-secret-for-ci-only"
  NEXT_PUBLIC_SITE_URL: "http://localhost:3000"
  GITHUB_CLIENT_ID: "test-github-client-id"
  GITHUB_CLIENT_SECRET: "test-github-client-secret"
  GOOGLE_CLIENT_ID: "test-google-client-id"
  GOOGLE_CLIENT_SECRET: "test-google-client-secret"

jobs:
  pr-check:
    name: PR Checks (sequential)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Show tool versions
        run: |
          node -v
          pnpm -v

      - name: Install dependencies (frozen lockfile)
        run: pnpm install --recursive --frozen-lockfile

      - name: Ensure Prisma CLI is available
        run: pnpm --filter @repo/database exec prisma --version

      - name: Generate DB types
        run: pnpm --filter @repo/database exec prisma generate --no-hints --schema=./prisma/schema.prisma

      - name: Build backend packages
        run: pnpm -w run build:backend

      - name: Run backend linting
        run: pnpm -w run backend:lint

      - name: Verify Biome (no changes pending)
        run: pnpm biome ci .

      - name: Run unit tests with coverage
        run: pnpm -w vitest run --coverage --reporter=dot

      - name: Run backend e2e (API)
        run: pnpm run backend:e2e

      - name: Run web e2e (Playwright)
        run: pnpm --filter @repo/web e2e:ci

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30
