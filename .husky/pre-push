#!/bin/sh

set -eu

if [ "${SKIP_PRE_PUSH:-0}" = "1" ]; then
  echo "SKIP_PRE_PUSH=1 set; skipping pre-push checks"
  exit 0
fi

run_job() {
  job="$1"
  printf '▶ %s\n' "$job"
  if ! eval "$job"; then
    printf '❌ %s failed\n' "$job" >&2
    exit 1
  fi
}

run_job "pnpm -w run ci:local:lint"
run_job "pnpm -w run ci:local:unit"
run_job "pnpm -w run ci:local:be"
run_job "pnpm -w run ci:local:web"

# Enforce Claude update trailer and docs rule
last_msg="$(git log -1 --pretty=%B)"
case "$last_msg" in
  *"Claude-Update: yes"*)
    if ! git show --name-only --pretty="" HEAD | grep -E "^(CLAUDE/|CLAUDE.md)" >/dev/null; then
      echo "Claude-Update: yes but no CLAUDE docs changed in last commit" >&2
      exit 1
    fi
    ;;
  *"Claude-Update: no"*)
    ;;
  *)
    echo "Missing required commit trailer: 'Claude-Update: yes|no'" >&2
    exit 1
    ;;
esac
